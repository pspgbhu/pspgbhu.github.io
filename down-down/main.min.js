var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),__awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(r,o){function s(t){try{h(n.next(t))}catch(e){o(e)}}function a(t){try{h(n["throw"](t))}catch(e){o(e)}}function h(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(s,a)}h((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return n([t,e])}}function n(i){if(r)throw new TypeError("Generator is already executing.");for(;h;)try{if(r=1,o&&(s=o[2&i[0]?"return":i[0]?"throw":"next"])&&!(s=s.call(o,i[1])).done)return s;switch(o=0,s&&(i=[0,s.value]),i[0]){case 0:case 1:s=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,o=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(s=h.trys,!(s=s.length>0&&s[s.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!s||i[1]>s[0]&&i[1]<s[3])){h.label=i[1];break}if(6===i[0]&&h.label<s[1]){h.label=s[1],s=i;break}if(s&&h.label<s[2]){h.label=s[2],h.ops.push(i);break}s[2]&&h.ops.pop(),h.trys.pop();continue}i=e.call(t,h)}catch(n){i=[6,n],o=0}finally{r=s=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var r,o,s,a,h={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},Flyer=function(t){function e(){var e=t.call(this)||this;return e.coled=!1,e}return __extends(e,t),e.prototype.init=function(){this.beforeInit(),this.x=Math.round(Math.random()*(this.stage.stageWidth-this.width)),this.y=this.stage.stageHeight+this.imgHeight,this.graphics.lineStyle(10,65280)},e.prototype.animation=function(t){var e=this;return new Promise(function(i,n){var r=egret.Tween.get(e,{onChange:t});r.to({y:-e.imgHeight},Control.speed).call(function(){return i()})})},e}(egret.Sprite);__reflect(Flyer.prototype,"Flyer");var GameLayer=function(t){function e(){var e=t.call(this)||this;return e.healthInterval=CONFIG.GIFT_INTERVAL,e.monsterInterval=CONFIG.MONSTER_INTERVAL,e.score=0,e.overFn=[],e.addEventListener(egret.Event.REMOVED_FROM_STAGE,e.handleRemoved,e),e.removed=!1,e.step=0,e.MONSTER_WIDTH=76,e.gameover=!1,e}return __extends(e,t),e.prototype.init=function(){this.player=new Player,this.hill=new Hill,this.activeChild(this.hill,this.player),this.allotPosition(),this.addFlyers(),this.tita(),this.drawTop()},e.prototype.listenGameover=function(t){this.overFn.push(t)},e.prototype.tita=function(){var t=this,e=function(){setTimeout(function(){t.step+=1,CONFIG.STEP[t.step]&&(Control=CONFIG.STEP[t.step],console.log("关卡",t.step),e())},CONFIG.STEP_TIME)};e()},e.prototype.addFlyers=function(){var t=this,e=function(){setTimeout(function(){if(!t.removed&&!t.gameover){for(var i=0;i<Control.gift_max;i++)t.addGift();e()}},Control.gift_interval)};e();var i=function(){setTimeout(function(){if(!t.removed&&!t.gameover){for(var e=Utils.shuffle(t.positionArray),n=0;n<Control.monster_max;n++){var r=e[n];t.addMonsters(r)}i()}},Control.monster_interval)};i()},e.prototype.addGift=function(){var t=this,e=new FlyerGift;this.addChild(e),e.init(),e.animation(function(){var i=Utils.collisionsDetection(t.player,e);i&&t.handleCollisions(e)}).then(function(){t.removeFlyer(e),e=null})},e.prototype.addMonsters=function(t){var e=this,i=new FlyerMonster;this.addChild(i),i.init(),i.x=t,i.animation(function(){var t=Utils.collisionsDetection(e.player,i);t&&e.handleCollisions(i)}).then(function(){e.removeFlyer(i),i=null})},e.prototype.removeFlyer=function(t){t&&t&&t.parent&&t.parent.removeChild(t)},e.prototype.allotPosition=function(){for(var t=76,e=Math.ceil(this.stage.stageWidth/t),i=[],n=0;e>n;n++)i.push(t*n);this.positionArray=i},e.prototype.handleCollisions=function(t){if(!t.coled){t.coled=!0;var e=this,i={health:function(){e.removeFlyer(t),e.score+=1,console.log("得分",e.score)},monster:function(){e.handleDead()}};i[t.state]()}},e.prototype.handleDead=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){switch(e.label){case 0:return this.gameover=!0,egret.Tween.removeAllTweens(),this.player.removeTouchHandle(),[4,this.player.animationDead()];case 1:return e.sent(),this.overFn.forEach(function(e){"function"==typeof e&&e(t.score)}),[2]}})})},e.prototype.activeChild=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=0;i<t.length;i++){var n=t[i];this.addChild(n),n.init()}},e.prototype.handleRemoved=function(){console.log("game layer remove"),this.removed=!0},e.prototype.drawTop=function(){var t=new egret.Bitmap(RES.getRes("top"));t.height=97,t.width=this.stage.width,this.addChild(t),this.scoreText=new egret.TextField,this.scoreText.text="0",this.scoreText.x=this.width/2-35,this.scoreText.y=18,this.scoreText.width=70,this.scoreText.height=100,this.scoreText.size=40,this.scoreText.textAlign="center",this.addChild(this.scoreText)},Object.defineProperty(e.prototype,"score",{get:function(){return this._score},set:function(t){this._score=t,this.updateScore(t)},enumerable:!0,configurable:!0}),e.prototype.updateScore=function(t){this.scoreText&&(this.scoreText.text=this.score.toString())},e}(egret.Sprite);__reflect(GameLayer.prototype,"GameLayer");var BeginLayer=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.initSize(),this.addTitle(),this.addDescriptions(CONFIG.BEGIN_STR),this.addButton(),[4,this.handleEvent()];case 1:return t.sent(),[2]}})})},e.prototype.initSize=function(){this.x=0,this.y=0,this.width=this.stage.stageWidth,this.height=this.stage.stageHeight},e.prototype.addTitle=function(){this.title=new egret.Bitmap(RES.getRes("title")),this.title.width=549,this.title.height=154,this.title.x=(this.width-this.title.width)/2,this.title.y=200,this.addChild(this.title)},e.prototype.addDescriptions=function(t){var e=Utils.textField(t);e.fontFamily="Helvetica Neue,Helvetica,Arial,Microsoft Yahei,sans-serif",e.size=36,e.lineSpacing=20,e.textColor=16777215,e.width=this.title.width,e.x=this.title.x,e.y=this.title.y+this.title.height+50,this.addChild(e)},e.prototype.addButton=function(){this.btn=new egret.Bitmap(RES.getRes("btn_start")),this.btn.width=408,this.btn.height=81,this.btn.anchorOffsetX=this.btn.width/2,this.btn.anchorOffsetY=this.btn.height/2,this.btn.x=(this.width-this.btn.width)/2+this.btn.anchorOffsetX,this.btn.y=this.height-this.btn.height-100+this.btn.anchorOffsetY,this.addChild(this.btn)},e.prototype.handleEvent=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return[2,new Promise(function(e){function i(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.btn.removeEventListener(egret.TouchEvent.TOUCH_TAP,i,this),[4,this.animation(this.btn)];case 1:return t.sent(),[4,this.showGuide()];case 2:return t.sent(),e(),[2]}})})}t.btn.touchEnabled=!0,t.btn.addEventListener(egret.TouchEvent.TOUCH_TAP,i,t)})]})})},e.prototype.showGuide=function(){var t=this;this.removeChildren();var e=new egret.Bitmap(RES.getRes("left"));e.width=64,e.height=64,e.x=100,e.y=900;var i=new egret.Bitmap(RES.getRes("left"));i.width=64,i.height=64,i.anchorOffsetX=i.width/2,i.anchorOffsetY=i.height/2,i.x=this.width-100-i.anchorOffsetX,i.y=900+i.anchorOffsetY,i.rotation=180;var n=new egret.TextField;return n.text=CONFIG.GUIDE_STR,n.y=e.y+18,n.width=this.width,n.textAlign=egret.HorizontalAlign.CENTER,this.addChild(e),this.addChild(i),this.addChild(n),new Promise(function(e){function i(){this.stage.removeEventListener(egret.TouchEvent.TOUCH_TAP,i,this),e()}t.touchEnabled=!0,t.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,i,t)})},e.prototype.animation=function(t){var e=egret.Tween.get(this.btn);return new Promise(function(t){e.to({scaleX:1.3,scaleY:.8},100,egret.Ease.sineIn).wait(0).to({scaleX:1,scaleY:1},100,egret.Ease.sineIn).wait(0).to({scaleX:1.2,scaleY:.9},100,egret.Ease.sineIn).wait(0).to({scaleX:1,scaleY:1},100,egret.Ease.sineIn).wait(0).to({scaleX:1.1,scaleY:.95},70,egret.Ease.sineIn).wait(0).to({scaleX:1,scaleY:1},70,egret.Ease.sineIn).call(function(){t()})})},e}(egret.Sprite);__reflect(BeginLayer.prototype,"BeginLayer");var FlyerGift=function(t){function e(){var e=t.call(this)||this;return e.imgHeight=56,e.state="health",e}return __extends(e,t),e.prototype.beforeInit=function(){this.width=this.imgHeight,this.height=50;var t=new egret.Bitmap(RES.getRes("heart"));t.width=this.width,t.height=this.height,this.addChild(t)},e}(Flyer);__reflect(FlyerGift.prototype,"FlyerGift");var FlyerMonster=function(t){function e(){var e=t.call(this)||this;return e.imgHeight=111,e.state="monster",e}return __extends(e,t),e.prototype.beforeInit=function(){var t=35;this.width=this.imgHeight-t,this.height=105-t;var e=new egret.Bitmap(RES.getRes("rangifer"));e.width=this.width+t,e.height=this.height+t,e.x=-t/3,e.y=-t/2,this.addChild(e)},e}(Flyer);__reflect(FlyerMonster.prototype,"FlyerMonster");var CONFIG={SPEED:2e3,GIFT_INTERVAL:1e3,MONSTER_INTERVAL:1500,BEGIN_STR:"跨年啦!快来帮 joy 收集礼品盒吧，1599 扫地机、智能插座和优惠券免费送!关注“京东微联”公众号会额外获得 3 次 机会哦~快来玩吧~",GUIDE_STR:"左右滑动，躲避麋鹿",MAX_GIFTS:300,STEP_TIME:1e4,STEP:[{speed:2e3,gift_interval:500,gift_max:1,monster_interval:1300,monster_max:1},{speed:1700,gift_interval:500,gift_max:1,monster_interval:1100,monster_max:2},{speed:1400,gift_interval:500,gift_max:1,monster_interval:1e3,monster_max:3},{speed:1100,gift_interval:500,gift_max:1,monster_interval:900,monster_max:3},{speed:900,gift_interval:500,gift_max:1,monster_interval:800,monster_max:4},{speed:700,gift_interval:500,gift_max:1,monster_interval:800,monster_max:4},{speed:500,gift_interval:500,gift_max:1,monster_interval:800,monster_max:4},{speed:500,gift_interval:500,gift_max:1,monster_interval:800,monster_max:4},{speed:500,gift_interval:500,gift_max:1,monster_interval:800,monster_max:5},{speed:500,gift_interval:500,gift_max:1,monster_interval:800,monster_max:5},{speed:500,gift_interval:500,gift_max:1,monster_interval:800,monster_max:6},{speed:500,gift_interval:500,gift_max:1,monster_interval:800,monster_max:7},{speed:500,gift_interval:500,gift_max:1,monster_interval:800,monster_max:8}]},Control=CONFIG.STEP[0],Hill=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.REMOVED_FROM_STAGE,e.handleRemoved,e),e}return __extends(e,t),e.prototype.init=function(){this.draw(),this.animation()},e.prototype.animation=function(){this.tw=egret.Tween.get(this,{loop:!0}),this.tw.to({y:-this.height/2},1.2*Control.speed)},e.prototype.stopAnimation=function(){egret.Tween.removeTweens(this)},e.prototype.draw=function(){this.width=this.stage.width,this.height=2*this.stage.height,this.x=0,this.y=0,this.appendImgs()},e.prototype.appendImgs=function(){var t=this.factoryImage();t.x=0,t.y=0;var e=this.factoryImage();e.x=0,e.y=this.stage.height;var i=this.factoryImage();i.x=this.stage.width,i.y=this.stage.height,i.rotation=180;var n=this.factoryImage();n.x=this.stage.width,n.y=2*this.stage.height,n.rotation=180,this.addChilds(t,e,i,n)},e.prototype.factoryImage=function(){var t=new egret.Bitmap(RES.getRes("hill"));return t.width=100,t.height=this.stage.height,t},e.prototype.addChilds=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];e.forEach(function(e){t.addChild(e)},this)},e.prototype.handleRemoved=function(){this.stopAnimation()},e}(egret.Sprite);__reflect(Hill.prototype,"Hill");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){var t=new egret.Shape;t.graphics.beginFill(12819920),t.graphics.drawRect(0,0,640,1136),t.graphics.endFill(),this.addChild(t),this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this.beginLayer=new BeginLayer,this.gameLayer=new GameLayer,this.addBackground(),this.addChild(this.beginLayer),[4,this.beginLayer.init()];case 1:return t.sent(),this.removeChild(this.beginLayer),this.beginLayer=null,this.addChild(this.gameLayer),this.gameLayer.init(),[4,this.waitToGameOver()];case 2:return t.sent(),alert("Game Over! 大侠的得分为 "+this.gameLayer.score+" 分"),window.location.reload(),[2]}})})},e.prototype.addBackground=function(){var t=new egret.Bitmap(RES.getRes("bg_png")),e=this.stage.stageWidth,i=this.stage.stageHeight;t.width=e,t.height=i,this.addChild(t)},e.prototype.waitToGameOver=function(){var t=this;return new Promise(function(e){t.gameLayer.listenGameover(function(t){e(t)})})},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.startAnimation=function(t){var e=this,i=new egret.HtmlTextParser,n=t.map(function(t){return i.parse(t)}),r=this.textfield,o=-1,s=function(){o++,o>=n.length&&(o=0);var t=n[o];r.textFlow=t;var i=egret.Tween.get(r);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(s,e)};s()},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var Player=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.init=function(){this.draw(),this.bindEvent(),this.addEventListener(egret.Event.REMOVED_FROM_STAGE,this.removeTouchHandle,this)},e.prototype.removeTouchHandle=function(){this.stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.handleTouchBegin,this),this.stage.removeEventListener(egret.TouchEvent.TOUCH_END,this.handleTouchEnd,this),this.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.handleTouchMove,this)},e.prototype.animationDead=function(){var t=this;return new Promise(function(e){var i=egret.Tween.get(t.img);console.log(t.alpha),i.to({alpha:.5},400).wait(0).to({alpha:1},400).wait(0).to({alpha:.5},400).wait(0).to({alpha:1},400).wait(0).to({alpha:.5},400).wait(0).to({alpha:1},400).call(function(){e()})})},e.prototype.draw=function(){var t=80,e=120;this.width=172-t,this.height=213-e,this.x=this.stage.stageWidth/2-this.width/2,this.y=250,this.img=new egret.Bitmap(RES.getRes("player")),this.img.width=this.width+t,this.img.height=this.height+e,this.img.x=-t+20,this.img.y=-e/2-20,this.addChild(this.img)},e.prototype.bindEvent=function(){this.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.handleTouchBegin,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.handleTouchEnd,this)},e.prototype.handleTouchBegin=function(t){this.touchStartX=t.stageX,this.touchStartY=t.stageY,this.TargetStartX=this.x,this.TargetStartY=this.y,this.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.handleTouchMove,this)},e.prototype.handleTouchEnd=function(t){this.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.handleTouchMove,this)},e.prototype.handleTouchMove=function(t){var e=t.stageX-this.touchStartX,i=this.TargetStartX+e;i>this.stage.stageWidth-this.width/2?i=this.stage.stageWidth-this.width/2:i<-this.width/2&&(i=-this.width/2),this.x=i},e}(egret.Sprite);__reflect(Player.prototype,"Player");var Utils={collisionsDetection:function(t,e){var i=t.x+t.width>=e.x&&e.x+e.width>=t.x,n=t.y+t.height>=e.y&&e.y+e.height>=t.y;return i&&n},textField:function(t){var e=new egret.TextField;return e.text=t,e},fillBg:function(t,e){t.graphics.beginFill(255,.5),t.graphics.drawRect(0,0,t.width,t.height),t.graphics.endFill()},shuffle:function(t){for(var e=t.concat(),i=e.length;i--;){var n=Math.floor(Math.random()*(i+1)),r=e[i];e[i]=e[n],e[n]=r}return e}};